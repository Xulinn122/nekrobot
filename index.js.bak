const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');
const { Configuration, OpenAIApi } = require('openai');
const fs = require('fs');
const ytdl = require('ytdl-core');
const path = require('path');
// === SEUS TOKENS ===
const telegramToken = '7951658490:AAEgYFBm7q3-e5Ah_zyaNi4RJIE1lG45DKY';
const openWeatherKey = 'https://cep.awesomeapi.com.br/:format/:cep';
//const openaiKey = 'SUA_CHAVE_OPENAI';

// === BOT CONFIG ===

const bot = new TelegramBot(telegramToken, { polling: true });
//const openai = new OpenAIApi(new Configuration({ apiKey: openaiKey }));

// === COMANDO /START ===
bot.onText(/\/start/, (msg) => {
  bot.sendMessage(msg.chat.id, `üëã Ol√° ${msg.from.first_name}!\nDigite /menu para ver op√ß√µes ou /help para ajuda.`);
});

// === COMANDO /HELP ===
bot.onText(/\/help/, (msg) => {
  bot.sendMessage(msg.chat.id, `
üõ†Ô∏è *Comandos Dispon√≠veis*:
/start - Iniciar o bot
/help - Ver ajuda
/menu - Menu com bot√µes
/teclado - Ativar teclado
/play - link do Youtube
/dolar - Cota√ß√£o do d√≥lar
/ia [pergunta] - Fale com a IA
  `, { parse_mode: "Markdown" });
});

// === MENU INLINE ===
/*bot.onText(/\/menu/, (msg) => {
   const opts = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üìÑ Info', callback_data: 'info' }, { text: 'üí¨ Ajuda', callback_data: 'ajuda' }],
        [{ text: 'üå¶Ô∏è Clima', callback_data: 'clima' }, { text: 'üíµ D√≥lar', callback_data: 'dolar' }],
        [{ text: 'üåê Site', url: 'https://seusite.com' }]
>]
    }
  };
  bot.sendMessage(msg.chat.id, 'Menu:', opts);
  const imageUrl = 'https://storage.oberonhosting.com.br/media/b330e93c154d3df9.jpg';
  bot.sendPhoto(chatId, imageUrl, options);
});
*/
/*bot.onText(/\/menu/, (msg) => {
  const chatId = msg.chat.id;
  const imgData = JSON.parse(fs.readFileSync('img.link.json', 'utf8'));
  const imageUrl = imgData.menu;

  // Bot√µes do menu
  const opts = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'üìÑ Info', callback_data: 'info' }, { text: 'üí¨ Ajuda', callback_data: 'ajuda' }],
        [{ text: 'üéµplay', callback_data: 'play' }, { text: 'üíµ D√≥lar', callback_data: 'dolar' }],
        [{ text: 'üåê Site', url: 'https://seusite.com' }]
      ]
    }
  };

  // Envia a imagem com os bot√µes
  bot.sendPhoto(chatId, imageUrl, {
    caption: 'Menu:',
    reply_markup: opts.reply_markup
  });
});

*/

bot.onText(/\/menu/, (msg) => {
¬† const chatId = msg.chat.id;
¬† const fs = require('fs');
¬† const imgData = JSON.parse(fs.readFileSync('img.link.json', 'utf8'));
¬† const imageUrl = imgData.menu;

¬† const legendaMenu = `
‚îÄ‚îÄ‚îÄ◊Ç‚îÄ÷¥‚îÄÍÜ¨üåôÍÜ¨‚îÄ÷¥‚îÄ‚îÄ◊Ç‚îÄ‚îÄ
*„ÄéùêèùêÄùêàùêçùêÑùêã ùêëùêÄùêèùêàùêÉ‚ùçÃ∏„Äè*
‚îÄ‚îÄ‚îÄ◊Ç‚îÄ÷¥‚îÄÍÜ¨üåôÍÜ¨‚îÄ÷¥‚îÄ‚îÄ◊Ç‚îÄ‚îÄ
‚îú‚ó®◊Ñ‚úø÷º  #Play2 (nome)
‚îú‚ó®◊Ñ‚úø÷º  #Tiktok (link)
‚îú‚ó®◊Ñ‚úø÷º  #Tiktoksrch (nome)
‚îÄ‚îÄ‚îÄ◊Ç‚îÄ÷¥‚îÄÍÜ¨üåôÍÜ¨‚îÄ÷¥‚îÄ‚îÄ◊Ç‚îÄ‚îÄ
*„ÄéùêèùêÄùêàùêçùêÑùêã ùêëùêÄùêèùêàùêÉ‚ùçÃ∏„Äè*
‚îÄ‚îÄ‚îÄ◊Ç‚îÄ÷¥‚îÄÍÜ¨üåôÍÜ¨‚îÄ÷¥‚îÄ‚îÄ◊Ç‚îÄ‚îÄ`;

¬† const opts = {
¬† ¬† reply_markup: {
¬† ¬† ¬† inline_keyboard: [
¬† ¬† ¬† ¬† [
¬† ¬† ¬† ¬† ¬† { text: 'üìÑ Info', callback_data: 'info' },
¬† ¬† ¬† ¬† ¬† { text: 'üí¨ Ajuda', callback_data: 'ajuda' }
¬† ¬† ¬† ¬† ],
¬† ¬† ¬† ¬† [
¬† ¬† ¬† ¬† ¬† { text: 'üéµ Play2', callback_data: 'play2' },
¬† ¬† ¬† ¬† ¬† { text: 'üì± TikTok', callback_data: 'tiktok' }
¬† ¬† ¬† ¬† ],
¬† ¬† ¬† ¬† [
¬† ¬† ¬† ¬† ¬† { text: 'üîç TikTok Search', callback_data: 'tiktoksrch' }
¬† ¬† ¬† ¬† ],
¬† ¬† ¬† ¬† [
¬† ¬† ¬† ¬† ¬† { text: 'üíµ D√≥lar', callback_data: 'dolar' }
¬† ¬† ¬† ¬† ],
¬† ¬† ¬† ¬† [
¬† ¬† ¬† ¬† ¬† { text: 'üåê Site', url: 'https://seusite.com' }
¬† ¬† ¬† ¬† ]
¬† ¬† ¬† ]
¬† ¬† }
¬† };

¬† bot.sendPhoto(chatId, imageUrl, {
¬† ¬† caption: legendaMenu,
¬† ¬† parse_mode: 'Markdown',
¬† ¬† reply_markup: opts.reply_markup
¬† });
});


bot.on('callback_query', (query) => {
  const { data, message, from } = query;
  if (data === 'info') {
    bot.sendMessage(message.chat.id, `üë§ Seu nome: ${from.first_name}\nüÜî ID: ${from.id}`);
  } else if (data === 'ajuda') {
    bot.sendMessage(message.chat.id, 'Digite /help para ver a lista de comandos.');
  } else if (data === 'play2') {
    bot.sendMessage(message.chat.id, 'Digite: /play2 nome da m√∫sica');
  } else if (data === 'dolar') {
    bot.sendMessage(message.chat.id, 'Digite: /dolar');
  }
  bot.answerCallbackQuery(query.id);
});

// === TECLADO REPLY ===
bot.onText(/\/teclado/, (msg) => {
  bot.sendMessage(msg.chat.id, 'Teclado ativado:', {
    reply_markup: {
      keyboard: [['üìÑ Info', 'üí¨ Ajuda'], ['üîô Voltar']],
      resize_keyboard: true,
      one_time_keyboard: false
    }
  });
});

bot.on('message', (msg) => {
  const text = msg.text;
  const chatId = msg.chat.id;

  if (text === 'üìÑ Info') {
    bot.sendMessage(chatId, `üë§ Nome: ${msg.from.first_name}`);
  } else if (text === 'üí¨ Ajuda') {
    bot.sendMessage(chatId, 'Use o comando /help para ver todos os comandos.');
  } else if (text === 'üîô Voltar') {
    bot.sendMessage(chatId, 'Voltando...');
  }
});

//=== COMANDO /TIKTOKSRCH===
bot.onText(/\/tiktoksrch (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const query = match[1];

  if (!query) {
    return bot.sendMessage(chatId, "‚ùå Coloque um t√≠tulo para a pesquisa.");
  }

  bot.sendChatAction(chatId, 'upload_video');

  try {
    const res = await axios.get('https://nodz-apis.com.br/api/pesquisas/tiktok', {
      params: {
        query,
        apiKey: '3e39fa09b0'
      }
    });

    if (!res.data || !res.data.resultado || !res.data.resultado.videos) {
      return bot.sendMessage(chatId, "‚ùå N√£o encontrei nenhum resultado para essa pesquisa.");
    }

    const i = res.data.resultado;
    const nulo = 'Sem Informa√ß√µes';

    const desc = `
üíïñß∑ *Pesquisa:* ${query || nulo}
üìÇñß∑ *Tipo:* ${i.type || nulo}
‚ú®ñß∑ *Tags:* ${i.titulo || nulo}
    `.trim();

    // Enviar v√≠deo
    await bot.sendVideo(chatId, i.videos, {
      caption: desc,
      parse_mode: 'Markdown'
    });

    // Enviar √°udio separado
    await bot.sendAudio(chatId, i.audio, {
      title: i.titulo || 'Sem t√≠tulo',
      performer: i.type || 'Desconhecido'
    });

  } catch (err) {
    console.error(err);
    bot.sendMessage(chatId, "‚ùå N√£o consegui realizar o download da pesquisa.");
  }
});
//=== COMANDO /TIKTOK===
bot.onText(/\/tiktok (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const url = match[1];

  if (!url.includes("vm.tiktok.com") && !url.includes("tiktok.com")) {
    return bot.sendMessage(chatId, "‚ùå Voc√™ deve enviar um link v√°lido do TikTok.");
  }

  bot.sendChatAction(chatId, 'upload_video');

  try {
    const res = await axios.get('https://nodz-apis.com.br/api/downloads/tiktok/dl', {
      params: {
        url,
        apiKey: '3e39fa09b0'
      }
    });

    if (!res.data || !res.data.resultado || !res.data.resultado.play) {
      return bot.sendMessage(chatId, "‚ùå N√£o obtive nenhum resultado para esse v√≠deo.");
    }

    const i = res.data.resultado;
    const nulo = 'Sem Informa√ß√µes';

    const desc = `
üéµ *V√≠deo do TikTok*
‚ñ∂Ô∏è *Reprodu√ß√µes:* ${i.play_count || nulo}
üí¨ *Coment√°rios:* ${i.comment_count || nulo}
üíï *Compartilhamentos:* ${i.share_count || nulo}
üìÇ *Downloads:* ${i.download_count || nulo}
üëë *Autor:* ${i.author?.nickname || nulo}
‚ú® *Descri√ß√£o:* ${i.title || nulo}
    `.trim();

    await bot.sendVideo(chatId, i.play, {
      caption: desc,
      parse_mode: 'Markdown'
    });

  } catch (err) {
    console.error(err);
    bot.sendMessage(chatId, "‚ùå Erro ao baixar o v√≠deo. Tente novamente mais tarde.");
  }
});
// === COMANDO /M√öSICA===
bot.onText(/^\/play2 (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const query = match[1];

  if (!query) {
    return bot.sendMessage(chatId, 'üéµ Envie o nome da m√∫sica ap√≥s o comando, exemplo: /play2 Nirvana');
  }

  await bot.sendChatAction(chatId, 'typing');

  try {
    const res = await axios.get('https://nodz-apis.com.br/api/downloads/playaudio', {
      params: {
        query,
        apiKey: '3e39fa09b0'
      }
    });

    const resultado = res.data.resultado;

    if (!resultado || !resultado.audio) {
      return bot.sendMessage(chatId, '‚ùå N√£o encontrei resultados para essa pesquisa.');
    }

    const titulo = resultado.titulo || 'Sem t√≠tulo';
    const descricao = resultado.descricao || '';
    const imagem = resultado.imagem;
    const filename = resultado.filename || 'audio.mp3';

    // Envia a thumb com t√≠tulo e descri√ß√£o
    await bot.sendPhoto(chatId, imagem, {
      caption: `üéµ *${titulo}*\n_${descricao}_`,
      parse_mode: 'Markdown'
    });

    // Envia o √°udio
    await bot.sendAudio(chatId, resultado.audio, {
      caption: `üéß Tocando agora: ${titulo}`,
      title: titulo,
      performer: descricao,
      filename: filename,
      thumb: imagem
    });

  } catch (err) {
    console.error(err);
    bot.sendMessage(chatId, '‚ùå Erro ao buscar ou enviar a m√∫sica.');
  }
});
// === COMANDO /DOLAR ===
bot.onText(/\/dolar/, async (msg) => {
  const chatId = msg.chat.id;

  try {
    const res = await axios.get('https://economia.awesomeapi.com.br/json/last/USD-BRL');
    const usd = res.data.USDBRL;

    bot.sendMessage(chatId, `
üíµ *Cota√ß√£o do D√≥lar*
üîπ Valor atual: R$ ${parseFloat(usd.bid).toFixed(2)}
üìà Alta: R$ ${parseFloat(usd.high).toFixed(2)}
üìâ Baixa: R$ ${parseFloat(usd.low).toFixed(2)}
    `, { parse_mode: "Markdown" });
  } catch (err) {
    bot.sendMessage(chatId, '‚ùå Erro ao buscar cota√ß√£o.');
  }
});

// === COMANDO /IA ===
bot.onText(/^\/(pin|pinterest)(?: (.+))?/, async (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const q = match[2];

  if (!q) {
    return bot.sendMessage(chatId, 'Digite o nome da imagem. Ex: /pin gato');
  }

  try {
    const res = await axios.get(`https://api.duckduckgo.com/`, {
      params: {
        q: q,
        format: 'json',
        no_redirect: 1,
        no_html: 1
      }
    });

    // Simples: pegar a primeira imagem da resposta
    const imagem = res.data?.Image;
    if (!imagem) {
      return bot.sendMessage(chatId, '‚ùå N√£o encontrei nenhuma imagem nessa busca.');
    }

    await bot.sendPhoto(chatId, imagem, {
      caption: `üîç Imagem para: ${q}`
    });

  } catch (e) {
    console.error(e);
    bot.sendMessage(chatId, 'Erro ao buscar imagem.');
  }
});